<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Radio Map</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            background-color: #f0f0f0;
        }
        #sidebar {
            width: 30%;
            height: 100%;
            overflow-y: auto;
            background: #fff;
            padding: 15px;
            box-sizing: border-box;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 1000;
        }
        #map {
            height: 100%;
            width: 70%;
        }
        #sidebar h2 {
            margin-top: 0;
            font-size: 1.2em;
        }
        #station-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        #station-list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #station-list li:hover {
            background-color: #e6f7ff;
        }
        #station-list li.playing {
            background-color: #cceeff;
            font-weight: bold;
        }
        #now-playing {
            margin-top: 20px;
            font-style: italic;
            color: #555;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2 id="sidebar-title">Stations in View</h2>
        <div id="now-playing">Select a station to play.</div>
        <ul id="station-list">
            <li>Finding a radio server...</li>
        </ul>
    </div>

    <div id="map"></div>

    <audio id="audio-player" style="display:none;"></audio>

    <script>
        const map = L.map('map').setView([48.85, 2.35], 6); // Start on Paris
        const stationList = document.getElementById('station-list');
        const audioPlayer = document.getElementById('audio-player');
        const nowPlayingDiv = document.getElementById('now-playing');
        const sidebarTitle = document.getElementById('sidebar-title');
        
        let currentPlayingLi = null;
        let apiServer = null;
        let currentCountryCode = null; // NEW: Track the current country

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        async function getApiServer() {
            try {
                const response = await fetch('https://all.api.radio-browser.info/json/servers');
                const servers = await response.json();
                const randomServer = servers[Math.floor(Math.random() * servers.length)];
                return `https://${randomServer.name}`;
            } catch (error) {
                return null;
            }
        }

        async function updateStations() {
            if (!apiServer) {
                apiServer = await getApiServer();
                if (!apiServer) {
                    stationList.innerHTML = '<li>Could not find a working radio server.</li>';
                    return;
                }
            }
            
            const center = map.getCenter();
            const lat = center.lat;
            const lng = center.lng;

            try {
                // 1. NEW: Get country code from coordinates using Nominatim API
                const geoResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=3`);
                const geoData = await geoResponse.json();
                const countryCode = geoData?.address?.country_code;

                if (!countryCode) {
                    sidebarTitle.textContent = "Unknown Area";
                    stationList.innerHTML = '<li>Move map to a country.</li>';
                    return;
                }
                
                // 2. NEW: Only fetch stations if the country has changed
                if (countryCode === currentCountryCode) {
                    return; // Don't re-fetch if we are still in the same country
                }
                
                currentCountryCode = countryCode; // Update the current country
                sidebarTitle.textContent = `Stations in ${geoData.address.country}`;
                stationList.innerHTML = '<li><p>Loading stations...</p></li>';

                // 3. NEW: Fetch stations by exact country code for better accuracy
                const apiUrl = `${apiServer}/json/stations/bycountrycodeexact/${countryCode}?hidebroken=true&order=clickcount&reverse=true`;
                
                const radioResponse = await fetch(apiUrl);
                if (!radioResponse.ok) throw new Error(`Network response was not ok`);
                
                const stations = await radioResponse.json();
                
                stationList.innerHTML = '';

                if (stations.length === 0) {
                    stationList.innerHTML = '<li>No stations found for this country.</li>';
                } else {
                    stations.forEach(station => {
                        if (station.url_resolved) {
                            const li = document.createElement('li');
                            li.textContent = station.name;
                            li.dataset.url = station.url_resolved;
                            stationList.appendChild(li);
                        }
                    });
                }
            } catch (error) {
                console.error("Failed to fetch stations:", error);
                stationList.innerHTML = '<li>Could not load stations.</li>';
            }
        }

        map.on('moveend', updateStations);

        stationList.addEventListener('click', (event) => {
            if (event.target?.nodeName === 'LI') {
                const stationLi = event.target;
                const stationUrl = stationLi.dataset.url;
                if (stationUrl) {
                    if (currentPlayingLi) {
                        currentPlayingLi.classList.remove('playing');
                    }
                    stationLi.classList.add('playing');
                    currentPlayingLi = stationLi;
                    
                    audioPlayer.src = stationUrl;
                    audioPlayer.play();
                    nowPlayingDiv.textContent = `Now Playing: ${stationLi.textContent}`;
                }
            }
        });

        // Initial load
        updateStations();
    </script>
</body>
</html>